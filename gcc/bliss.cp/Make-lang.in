# Top level -*- makefile -*- fragment for GNU C++.
#   Copyright (C) 1994, 1995, 1997, 1998, 1999, 2000, 2001
#   Free Software Foundation, Inc.

#This file is part of GNU CC.

#GNU CC is free software; you can redistribute it and/or modify
#it under the terms of the GNU General Public License as published by
#the Free Software Foundation; either version 2, or (at your option)
#any later version.

#GNU CC is distributed in the hope that it will be useful,
#but WITHOUT ANY WARRANTY; without even the implied warranty of
#MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#GNU General Public License for more details.

#You should have received a copy of the GNU General Public License
#along with GNU CC; see the file COPYING.  If not, write to
#the Free Software Foundation, 59 Temple Place - Suite 330,
#Boston, MA 02111-1307, USA.

# This file provides the language dependent support in the main Makefile.
# Each language makefile fragment must provide the following targets:
#
# foo.all.build, foo.all.cross, foo.start.encap, foo.rest.encap,
# foo.info, foo.dvi,
# foo.install-normal, foo.install-common, foo.install-info, foo.install-man,
# foo.uninstall,
# foo.mostlyclean, foo.clean, foo.distclean, foo.extraclean,
# foo.maintainer-clean, foo.stage1, foo.stage2, foo.stage3, foo.stage4
#
# where `foo' is the name of the language.
#
# It should also provide rules for:
#
# - making any compiler driver (eg: bliss)
# - the compiler proper (eg: bli1)
# - define the names for selecting the language in LANGUAGES.

LEX = flex

# Actual names to use when installing a native compiler.
BLISS_INSTALL_NAME = `echo bliss|sed '$(program_transform_name)'`
BLISS_INSTALL_NAME = `echo bliss|sed '$(program_transform_name)'`
DEMANGLER_INSTALL_NAME = `echo blissfilt|sed '$(program_transform_name)'`
BLISS_TARGET_INSTALL_NAME = $(target_alias)-`echo bliss|sed '$(program_transform_name)'`
BLISS_TARGET_INSTALL_NAME = $(target_alias)-`echo bliss|sed '$(program_transform_name)'`

# Actual names to use when installing a cross-compiler.
BLISS_CROSS_NAME = `echo bliss|sed '$(program_transform_cross_name)'`
BLISS_CROSS_NAME = `echo bliss|sed '$(program_transform_cross_name)'`
DEMANGLER_CROSS_NAME = `echo blissfilt|sed '$(program_transform_cross_name)'`

# The name to use for the demangler program.
DEMANGLER_PROG = blissfilt$(exeext)

#
# Define the names for selecting bliss in LANGUAGES.
# Note that it would be nice to move the dependency on bliss
# into the C++ rule, but that needs a little bit of work
# to do the right thing within all.cross.
bliss.cp: bli1$(exeext)

# Tell GNU make to ignore these if they exist.
.PHONY: bliss.cp

blissspec.o: $(srcdir)/bliss.cp/blissspec.c $(SYSTEM_H) $(GCC_H) $(CONFIG_H)
	(SHLIB_LINK='$(SHLIB_LINK)' \
	SHLIB_MULTILIB='$(SHLIB_MULTILIB)'; \
	$(CC) -c $(ALL_CFLAGS) $(ALL_CPPFLAGS) $(DRIVER_DEFINES) \
		$(INCLUDES) $(srcdir)/bliss.cp/blissspec.c)

po-generated: $(srcdir)/bliss.cp/parse.c

# Create the compiler driver for bliss.
GBLISS_OBJS = gcc.o blissspec.o intl.o prefix.o version.o 
bliss$(exeext): $(GBLISS_OBJS) $(EXTRA_GCC_OBJS) $(LIBDEPS)
	$(CC) $(ALL_CFLAGS) $(LDFLAGS) -o $@ \
	  $(GBLISS_OBJS) $(EXTRA_GCC_OBJS) $(LIBS)

# Create a version of the bliss driver which calls the cross-compiler.
bliss-cross$(exeext): bliss$(exeext)
	-rm -f bliss-cross$(exeext)
	cp bliss$(exeext) bliss-cross$(exeext)

# The demangler.
blissmain.o: $(srcdir)/../libiberty/cplus-dem.c $(DEMANGLE_H) $(CONFIG_H)
	rm -f blissmain.c
	$(LN_S) $(srcdir)/../libiberty/cplus-dem.c blissmain.c
	$(CC) -c -DMAIN $(ALL_CFLAGS) $(ALL_CPPFLAGS) $(INCLUDES) \
	  -DVERSION=\"$(version)\" blissmain.c

# Apparently OpenVM needs the -o to be at the beginning of the link line.
$(DEMANGLER_PROG): blissmain.o underscore.o $(LIBDEPS)
	$(CC) -o $@ $(ALL_CFLAGS) $(LDFLAGS) \
	  blissmain.o underscore.o $(LIBS)

# The compiler itself.
# Shared with C front end:
BLISS_C_OBJS = attribs.o c-common.o c-format.o c-pragma.o c-semantics.o c-lex.o \
 $(BLISS_TARGET_OBJS)

# Language-specific object files.
BLISS_OBJS = bliss.cp/call.o bliss.cp/decl.o bliss.cp/expr.o bliss.cp/pt.o bliss.cp/typeck2.o \
 bliss.cp/class.o bliss.cp/decl2.o bliss.cp/error.o bliss.cp/lex.o bliss.cp/blilex.o bliss.cp/parse.o bliss.cp/ptree.o bliss.cp/rtti.o \
 bliss.cp/spew.o bliss.cp/typeck.o bliss.cp/cvt.o bliss.cp/except.o bliss.cp/friend.o bliss.cp/init.o bliss.cp/method.o \
 bliss.cp/search.o bliss.cp/semantics.o bliss.cp/tree.o bliss.cp/repo.o bliss.cp/dump.o \
 bliss.cp/optimize.o bliss.cp/mangle.o bliss.cp/cp-lang.o

# Use loose warnings for this front end.
cp-warn =

bli1$(exeext): $(BLISS_OBJS) $(BLISS_C_OBJS) $(BACKEND) \
		  libcpp.a $(LIBDEPS)
	$(CC) $(ALL_CFLAGS) $(LDFLAGS) -o $@ \
	      $(BLISS_OBJS) $(BLISS_C_OBJS) $(BACKEND) libcpp.a $(LIBS)

# Special build rules.
$(srcdir)/bliss.cp/cfns.h: $(srcdir)/bliss.cp/cfns.gperf
	gperf -o -C -E -k '1-6,$$' -j1 -D -N 'libc_name_p' \
		$(srcdir)/bliss.cp/cfns.gperf > $(srcdir)/bliss.cp/cfns.h

bliss.cp/parse.h: bliss.cp/parse.c
bliss.cp/parse.c: $(srcdir)/bliss.cp/parse.y
	@echo "Expect 33 shift/reduce conflicts and 58 reduce/reduce conflicts."
	cd bliss.cp && \
	if $(BISON) $(BISONFLAGS) -d -o p$$$$.c ../$(srcdir)/bliss.cp/parse.y; then \
	  grep '^#define[ 	]*YYEMPTY' p$$$$.c >> p$$$$.h ; \
	  test -f p$$$$.output && mv -f p$$$$.output parse.output ; \
	  mv -f p$$$$.c parse.c ; mv -f p$$$$.h parse.h ; \
	else \
	  rm -f p$$$$.* ; \
	  false ; \
	fi

#
# Build hooks:

bliss.cp.all.build: bliss$(exeext)
bliss.cp.all.cross: bliss-cross$(exeext) $(DEMANGLER_PROG)
bliss.cp.start.encap: bliss$(exeext)
bliss.cp.rest.encap: $(DEMANGLER_PROG)

bliss.cp.info: 
bliss.cp.dvi:
bliss.cp.generated-manpages:

#
# Install hooks:
# bli1 is installed elsewhere as part of $(COMPILERS).

# Nothing to do here.
bliss.cp.install-normal:

# Install the driver program as $(target)-bliss
# and also as either bliss (if native) or $(tooldir)/bin/bliss.
bliss.cp.install-common: installdirs
	-if [ -f bli1$(exeext) ] ; then \
	  if [ -f bliss-cross$(exeext) ] ; then \
	    rm -f $(bindir)/$(BLISS_CROSS_NAME)$(exeext); \
	    $(INSTALL_PROGRAM) bliss-cross$(exeext) $(bindir)/$(BLISS_CROSS_NAME)$(exeext); \
	    chmod a+x $(bindir)/$(BLISS_CROSS_NAME)$(exeext); \
	    rm -f $(bindir)/$(BLISS_CROSS_NAME)$(exeext); \
	    $(LN) $(bindir)/$(BLISS_CROSS_NAME)$(exeext) $(bindir)/$(BLISS_CROSS_NAME)$(exeext); \
	    if [ -d $(gcc_tooldir)/bin/. ] ; then \
	      rm -f $(gcc_tooldir)/bin/bliss$(exeext); \
	      $(INSTALL_PROGRAM) bliss-cross$(exeext) $(gcc_tooldir)/bin/bliss$(exeext); \
	      rm -f $(gcc_tooldir)/bin/bliss$(exeext); \
	      $(LN) $(gcc_tooldir)/bin/bliss$(exeext) $(gcc_tooldir)/bin/bliss$(exeext); \
	    else true; fi; \
	  else \
	    rm -f $(bindir)/$(BLISS_INSTALL_NAME)$(exeext); \
	    $(INSTALL_PROGRAM) bliss$(exeext) $(bindir)/$(BLISS_INSTALL_NAME)$(exeext); \
	    chmod a+x $(bindir)/$(BLISS_INSTALL_NAME)$(exeext); \
	    rm -f $(bindir)/$(BLISS_INSTALL_NAME)$(exeext); \
	    $(LN) $(bindir)/$(BLISS_INSTALL_NAME)$(exeext) $(bindir)/$(BLISS_INSTALL_NAME)$(exeext); \
	    rm -f $(bindir)/$(BLISS_TARGET_INSTALL_NAME)$(exeext); \
	    $(LN) $(bindir)/$(BLISS_INSTALL_NAME)$(exeext) $(bindir)/$(BLISS_TARGET_INSTALL_NAME)$(exeext); \
	    rm -f $(bindir)/$(BLISS_TARGET_INSTALL_NAME)$(exeext); \
	    $(LN) $(bindir)/$(BLISS_INSTALL_NAME)$(exeext) $(bindir)/$(BLISS_TARGET_INSTALL_NAME)$(exeext); \
	  fi ; \
	  if [ x$(DEMANGLER_PROG) != x ] && [ -x "$(DEMANGLER_PROG)" ]; then \
	    if [ -f bliss-cross$(exeext) ] ; then \
	      rm -f $(bindir)/$(DEMANGLER_CROSS_NAME)$(exeext); \
	      $(INSTALL_PROGRAM) $(DEMANGLER_PROG) $(bindir)/$(DEMANGLER_CROSS_NAME)$(exeext); \
	      chmod a+x $(bindir)/$(DEMANGLER_CROSS_NAME)$(exeext); \
	    else \
	      rm -f $(bindir)/$(DEMANGLER_INSTALL_NAME)$(exeext); \
	      $(INSTALL_PROGRAM) $(DEMANGLER_PROG) $(bindir)/$(DEMANGLER_INSTALL_NAME)$(exeext); \
	      chmod a+x $(bindir)/$(DEMANGLER_INSTALL_NAME)$(exeext); \
	    fi ; \
	  fi ; \
	fi

bliss.cp.install-info: 

bliss.cp.install-man: installdirs $(srcdir)/bliss.cp/bliss.1
	-if [ -f bli1$(exeext) ] ; then \
	  if [ -f bliss-cross$(exeext) ] ; then \
	    rm -f $(man1dir)/$(BLISS_CROSS_NAME)$(man1ext); \
	    $(INSTALL_DATA) $(srcdir)/bliss.cp/bliss.1 $(man1dir)/$(BLISS_CROSS_NAME)$(man1ext); \
	    chmod a-x $(man1dir)/$(BLISS_CROSS_NAME)$(man1ext); \
	  else \
	    rm -f $(man1dir)/$(BLISS_INSTALL_NAME)$(man1ext); \
	    $(INSTALL_DATA) $(srcdir)/bliss.cp/bliss.1 $(man1dir)/$(BLISS_INSTALL_NAME)$(man1ext); \
	    chmod a-x $(man1dir)/$(BLISS_INSTALL_NAME)$(man1ext); \
	  fi; \
	else true; fi

bliss.cp.uninstall:
	-rm -rf $(bindir)/$(BLISS_INSTALL_NAME)$(exeext)
	-rm -rf $(bindir)/$(BLISS_CROSS_NAME)$(exeext)
	-rm -rf $(bindir)/$(BLISS_INSTALL_NAME)$(exeext)
	-rm -rf $(bindir)/$(BLISS_CROSS_NAME)$(exeext)
	-rm -rf $(bindir)/$(DEMANGLER_INSTALL_NAME)$(exeext)
	-rm -rf $(bindir)/$(DEMANGLER_CROSS_NAME)$(exeext)
	-rm -rf $(man1dir)/$(BLISS_INSTALL_NAME)$(man1ext)
	-rm -rf $(man1dir)/$(BLISS_CROSS_NAME)$(man1ext)
#
# Clean hooks:
# A lot of the ancillary files are deleted by the main makefile.
# We just have to delete files specific to us.

bliss.cp.mostlyclean:
	-rm -f bliss.cp/*$(objext) $(DEMANGLER_PROG)
bliss.cp.clean:
bliss.cp.distclean:
	-rm -f bliss.cp/config.status bliss.cp/Makefile
	-rm -f $(srcdir)/bliss.cp/parse.output
bliss.cp.extraclean:
bliss.cp.maintainer-clean:
	-rm -f $(srcdir)/bliss.cp/parse.c $(srcdir)/bliss.cp/parse.h
#
# Stage hooks:
# The main makefile has already created stage?/cp.

bliss.cp.stage1: stage1-start
	-mv bliss.cp/*$(objext) stage1/bliss.cp
bliss.cp.stage2: stage2-start
	-mv bliss.cp/*$(objext) stage2/bliss.cp
bliss.cp.stage3: stage3-start
	-mv bliss.cp/*$(objext) stage3/bliss.cp
bliss.cp.stage4: stage4-start
	-mv bliss.cp/*$(objext) stage4/bliss.cp

#
# .o: .h dependencies.
BLISS_TREE_H = $(TREE_H) bliss.cp/cp-tree.h c-common.h bliss.cp/cp-tree.def c-common.def \
	function.h varray.h $(SYSTEM_H) $(CONFIG_H) $(TARGET_H) \
	$(srcdir)/../include/hashtab.h $(srcdir)/../include/splay-tree.h

bliss.cp/spew.o: bliss.cp/spew.c $(BLISS_TREE_H) bliss.cp/parse.h flags.h bliss.cp/blilex.h toplev.h
bliss.cp/blilex.o: bliss.cp/blilex.c $(BLISS_TREE_H) bliss.cp/parse.h flags.h bliss.cp/blilex.h c-pragma.h \
  toplev.h output.h mbchar.h $(GGC_H) input.h diagnostic.h bliss.cp/operators.def \
  $(TM_P_H)
bliss.cp/cp-lang.o: bliss.cp/cp-lang.c $(BLISS_TREE_H) toplev.h langhooks.h $(LANGHOOKS_DEF_H) \
  c-common.h
bliss.cp/decl.o: bliss.cp/decl.c $(BLISS_TREE_H) flags.h bliss.cp/blilex.h bliss.cp/decl.h stack.h \
  output.h $(EXPR_H) except.h toplev.h hash.h $(GGC_H) $(RTL_H) \
  bliss.cp/operators.def $(TM_P_H) tree-inline.h diagnostic.h c-pragma.h
bliss.cp/decl2.o: bliss.cp/decl2.c $(BLISS_TREE_H) flags.h bliss.cp/blilex.h bliss.cp/decl.h $(EXPR_H) \
  output.h except.h toplev.h $(GGC_H) $(RTL_H)
bliss.cp/typeck2.o: bliss.cp/typeck2.c $(BLISS_TREE_H) flags.h toplev.h output.h $(TM_P_H) \
   diagnostic.h
bliss.cp/typeck.o: bliss.cp/typeck.c $(BLISS_TREE_H) flags.h $(RTL_H) $(EXPR_H) toplev.h \
   diagnostic.h
bliss.cp/class.o: bliss.cp/class.c $(BLISS_TREE_H) flags.h toplev.h $(RTL_H) $(TARGET_H)
bliss.cp/call.o: bliss.cp/call.c $(BLISS_TREE_H) flags.h toplev.h $(RTL_H) $(EXPR_H) \
     $(GGC_H) diagnostic.h
bliss.cp/friend.o: bliss.cp/friend.c $(BLISS_TREE_H) flags.h $(RTL_H) toplev.h $(EXPR_H)
bliss.cp/init.o: bliss.cp/init.c $(BLISS_TREE_H) flags.h $(RTL_H) $(EXPR_H) toplev.h \
  $(GGC_H) except.h
bliss.cp/method.o: bliss.cp/method.c $(BLISS_TREE_H) toplev.h $(GGC_H) $(RTL_H) $(EXPR_H) \
  $(TM_P_H)
bliss.cp/cvt.o: bliss.cp/cvt.c $(BLISS_TREE_H) bliss.cp/decl.h flags.h toplev.h convert.h
bliss.cp/search.o: bliss.cp/search.c $(BLISS_TREE_H) stack.h flags.h toplev.h $(RTL_H)
bliss.cp/tree.o: bliss.cp/tree.c $(BLISS_TREE_H) flags.h toplev.h $(GGC_H) $(RTL_H) \
  insn-config.h integrate.h tree-inline.h
bliss.cp/ptree.o: bliss.cp/ptree.c $(BLISS_TREE_H) $(SYSTEM_H)
bliss.cp/rtti.o: bliss.cp/rtti.c $(BLISS_TREE_H) flags.h toplev.h
bliss.cp/except.o: bliss.cp/except.c $(BLISS_TREE_H) flags.h $(RTL_H) except.h toplev.h \
  bliss.cp/cfns.h $(EXPR_H) libfuncs.h bliss.cp/decl.h $(OBSTACK_H)
bliss.cp/expr.o: bliss.cp/expr.c $(BLISS_TREE_H) $(RTL_H) flags.h $(EXPR_H) toplev.h \
  except.h $(TM_P_H)
bliss.cp/pt.o: bliss.cp/pt.c $(BLISS_TREE_H) bliss.cp/decl.h bliss.cp/parse.h bliss.cp/blilex.h toplev.h \
  $(GGC_H) $(RTL_H) except.h tree-inline.h
bliss.cp/error.o: bliss.cp/error.c $(BLISS_TREE_H) toplev.h diagnostic.h flags.h real.h
bliss.cp/repo.o: bliss.cp/repo.c $(BLISS_TREE_H) toplev.h $(GGC_H) diagnostic.h
bliss.cp/semantics.o: bliss.cp/semantics.c $(BLISS_TREE_H) bliss.cp/blilex.h except.h toplev.h \
  flags.h $(GGC_H) debug.h output.h $(RTL_H) $(TIMEVAR_H) $(EXPR_H) \
  tree-inline.h
bliss.cp/dump.o: bliss.cp/dump.c $(BLISS_TREE_H) tree-dump.h
bliss.cp/optimize.o: bliss.cp/optimize.c $(BLISS_TREE_H) rtl.h integrate.h insn-config.h \
  input.h $(PARAMS_H) debug.h tree-inline.h
bliss.cp/mangle.o: bliss.cp/mangle.c $(BLISS_TREE_H) toplev.h

blibld = bliss.cp

bliss.cp/parse.o: bliss.cp/parse.c $(BLISS_TREE_H) flags.h bliss.cp/blilex.h except.h output.h \
	$(SYSTEM_H) toplev.h $(GGC_H)
	$(CC) -c $(ALL_CFLAGS) $(ALL_CPPFLAGS) $(INCLUDES) $(BIG_SWITCHFLAG) \
		bliss.cp/parse.c $(OUTPUT_OPTION)
#
# These exist for maintenance purposes.

# Update the tags table.
bliss.cp/TAGS: force
	cd $(srcdir)/bliss.cp ;			\
	etags --no-globals -l c `echo *.c | sed 's/parse.c//'` \
	  parse.y *.h ../*.c ../*.h;

.PHONY: bliss.cp/TAGS

blisrc=$(srcdir)/bliss.cp

$(blibld)/blilex.c: $(blisrc)/blilex.l
	$(LEX) $(LEXFLAGS) -obliss.cp/blilex.c $(blisrc)/blilex.l

$(blisrc)/blicprs.c: $(blisrc)/blicprs.y
	$(BISON) $(BISONFLAGS) --name-prefix bli_ $(blisrc)/blicprs.y \
	--output=$(blisrc)/blicprs.c -d -k

GCC_FOR_BLISS = `if [ -f ./xgcc ] ; then \
	    echo ./xgcc ; \
	 else \
	    echo $(CC) ; \
	 fi`

BLISS_EXTRAS = -B./ -B./bliss.cp/

bliss.cp/blilex.o: $(blibld)/blilex.c $(blisrc)/blilex.h \
	 $(blisrc)/blicsyt.h\
	 $(BLI_UTIL_H)
	 $(GCC_FOR_BLISS) $(BLISS_EXTRAS) -o $@ -c $(ALL_CFLAGS) $(INCLUDES) $< 

bliss.cp/blicc1.o: $(blisrc)/blicc1.c \
	$(blisrc)/blicsyt.h \
	$(blisrc)/blicsyms.h
	$(GCC_FOR_BLISS) $(BLISS_EXTRAS) -o $@ -c $(ALL_CFLAGS) $(INCLUDES) $< 

